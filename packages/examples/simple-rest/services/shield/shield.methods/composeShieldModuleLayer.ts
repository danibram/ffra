/*{
  'layers': [
    {
      'layer": "Basic Glider Control Skills",
      "position": 0,
      "weight": 1,
      "areas": [
        {"order": 1, "colour": "#ff7f0e", "completed": 1, "name": "Basic Glider Control Skills", "size": 1, "data": "assets/shield-data/flare.json"}]
    },
    {
      "layer": "Skill Area",
      "position": 1,
      "weight": 1.2,
      "areas": [
        { "order": 1, "colour":"#1f77b4", "completed": 1, "size": 1, "name": "Launching and Groundhandling", "data": "assets/shield-data/towing-beginner.json"},
        { "order": 2, "colour":"#2ca02c", "completed": 1, "size": 1, "name": "Landing", "data": "assets/shield-data/glider-control-beginner.json"},
        { "order": 3, "colour":"#d62728", "completed": 1, "size": 1, "name": "Soaring", "data": "assets/shield-data/planning-beginner.json"},
        { "order": 4, "colour":"#9467bd", "completed": 1, "size": 1, "name": "Gliding", "data": "assets/shield-data/meteo-beginner.json"},
        { "order": 5, "colour":"#8c564b", "completed": 1, "size": 1, "name": "Thermalling", "data": "assets/shield-data/equipment-beginner.json"},
        { "order": 6, "colour":"#e377c2", "completed": 1, "size": 1, "name": "Descent techniques", "data": "assets/shield-data/airlaw-beginner.json"},
        { "order": 7, "colour":"#7f7f7f", "completed": 1, "size": 1, "name": "Active flying", "data": "assets/shield-data/xc-beginner.json"},
        { "order": 8, "colour":"#bcbd22", "completed": 1, "size": 1, "name": "Recovery techniques", "data": "assets/shield-data/sos-beginner.json"},
        { "order": 9, "colour":"#17becf", "completed": 1, "size": 1, "name": "Free style and Acro", "data": "assets/shield-data/towing-beginner.json"}

      ]
    },
    {
      "layer": "Foundation Layer Skills",
      "position": 2,
      "weight": 0.8,
      "areas": [
        { "order": 1, "colour":"#1f77b4",  "completed": 0, "size": 0.20, "name": "Reverse launching", "link": "pages/skill/foundation/reverse-launching"},
        { "order": 2, "colour":"#1f77b4",  "completed": 1, "size": 0.20, "name": "Forward launching", "data": null},
        { "order": 3, "colour":"#1f77b4",  "completed": 1, "size": 0.20, "name": "Contolling the glider in strong winds", "data": null},
        { "order": 4, "colour":"#1f77b4",  "completed": 1, "size": 0.20, "name": "Wing control", "data": null},
        { "order": 5, "colour":"#1f77b4",  "completed": 1, "size": 0.20, "name": "Assisting others on launch", "data": null},

        { "order": 6, "colour":"#2ca02c",  "completed": 1, "size": 0.20, "name": "Strong wind landing", "data": null},
        { "order": 7, "colour":"#2ca02c",  "completed": 1, "size": 0.20, "name": "Nil wind landing", "data": null},
        { "order": 8, "colour":"#2ca02c",  "completed": 1, "size": 0.20, "name": "Slope landing", "data": null},
        { "order": 9, "colour":"#2ca02c",  "completed": 1, "size": 0.20, "name": "Top landing", "data": null},
        { "order": 10, "colour":"#2ca02c", "completed": 1, "size": 0.20, "name": "Landing approaches", "data": null},

        { "order": 11, "colour": "#d62728", "completed": 1, "size": 0.33, "name": "Positioning", "data": null},
        { "order": 12, "colour": "#d62728", "completed": 1, "size": 0.33, "name": "Effective turns", "data": null},
        { "order": 13, "colour": "#d62728", "completed": 1, "size": 0.33, "name": "Use of terrain/Understanding lift", "data": null},

        { "order": 14, "colour": "#9467bd", "completed": 1, "size": 1, "name": "Gliding", "data": null, "visible": true},

        { "order": 15, "colour": "#8c564b", "completed": 1, "size": 1, "name": "Thermalling", "data": null, "visible": true},

        { "order": 16, "colour": "#e377c2", "completed": 1, "size": 0.25, "name": "Big ears", "data": null},
        { "order": 17, "colour": "#e377c2", "completed": 1, "size": 0.25, "name": "Speedbar", "data": null},
        { "order": 18, "colour": "#e377c2", "completed": 1, "size": 0.25, "name": "Big  ears & speedbar", "data": null},
        { "order": 19, "colour": "#e377c2", "completed": 1, "size": 0.25, "name": "Fly away from lift", "data": null},

        { "order": 20, "colour": "#7f7f7f", "completed": 1, "size": 0.20, "name": "Gentle jab on one brake and observe result", "data": null},
        { "order": 21, "colour": "#7f7f7f", "completed": 1, "size": 0.20, "name": "Gentle equal turns with Weight-shift only", "data": null},
        { "order": 22, "colour": "#7f7f7f", "completed": 1, "size": 0.20, "name": "Gentle Porpousing (no more than 30 degrees from above)", "data": null},
        { "order": 23, "colour": "#7f7f7f", "completed": 1, "size": 0.20, "name": "Balanced 90 degree turns", "data": null},
        { "order": 24, "colour": "#7f7f7f", "completed": 1, "size": 0.20, "name": "Balanced banked 180", "data": null},

        { "order": 25, "colour": "#bcbd22", "completed": 1, "size": 1, "name": "Recovery techniques", "data": null, "visible": true},

        { "order": 26, "colour": "#17becf", "completed": 1, "size": 1, "name": "Free style and Acro", "data": null, "visible": true}
      ]
    }
  ],
  "labels": [
    { "id": 1, "position": 1, "size": 1, "name": "Launching and Groundhandling"},
    { "id": 2, "position": 2, "size": 1, "name": "Landing"},
    { "id": 3, "position": 3, "size": 1, "name": "Soaring"},
    { "id": 4, "position": 4, "size": 1, "name": "Gliding"},
    { "id": 5, "position": 5, "size": 1, "name": "Thermalling"},
    { "id": 6, "position": 6, "size": 1, "name": "Descent techniques"},
    { "id": 7, "position": 7, "size": 1, "name": "Active flying"},
    { "id": 8, "position": 8, "size": 1, "name": "Recovery techniques"},
    { "id": 9, "position": 9, "size": 1, "name": "Free style and Acro"}
  ]
}
*/

import {
    userConfig,
    dataLayers,
    dataModules,
    skillAreas,
    skills,
    userProgress
} from './data'

const isSkillAreaCompleted = (skills, userProgress) => {
    let completed = 1
    skills.forEach(skill => {
        if (!userProgress[skill.id]) {
            completed = 0
        }
    })

    return completed
}

const composeSkillArea = (
    { id, order, colour, name },
    skills,
    userProgress
) => {
    let specificSkills = skills.filter(skill => skill.skillAreaId === id)

    return {
        order,
        colour,
        size: 1,
        completed: isSkillAreaCompleted(specificSkills, userProgress),
        name,
        data: null
    }
}

const composeSkills = (skillAreas, skills, userProgress) => {
    let composedSkills = []

    skillAreas.forEach(skillArea => {
        let specificSkills = skills.filter(s => s.skillAreaId === skillArea.id)
        specificSkills.forEach(skill => {
            composedSkills.push({
                order: composedSkills.length + 1,
                colour: skillArea.colour,
                completed: !userProgress[skill.id] ? 1 : 0,
                size: 1 / specificSkills.length,
                name: skill.name,
                data: null,
                visible: true
            })
        })
    })

    return composedSkills
}

export const composeSkillAreasSkills = function(
    userProgress,
    module,
    layer,
    skillAreas,
    skills
) {
    let layers = []
    layers.push({
        layer: `${layer.prelabel} ${module.name}`,
        position: 0,
        weight: 1,
        areas: [
            {
                order: 1,
                colour: '#ff7f0e',
                completed: 1,
                name: 'Basic Glider Control Skills',
                size: 1,
                data: 'assets/shield-data/flare.json'
            }
        ]
    })

    layers.push({
        layer: 'Skill Area',
        position: 1,
        weight: 1.2,
        areas: skillAreas.map(s => composeSkillArea(s, skills, userProgress))
    })

    layers.push({
        layer: `${layer.name} Layer Skills`,
        position: 1,
        weight: 0.8,
        areas: composeSkills(skillAreas, skills, userProgress)
    })

    return {
        layers,
        labels: skillAreas.map(({ id, position, name }) => ({
            id,
            position,
            size: 1,
            name
        }))
    }
}

export const composeShieldModuleLayer = async function(ctx, next) {
    ctx.hook.data = composeSkillAreasSkills(
        userProgress,
        dataModules[0],
        dataLayers[2],
        skillAreas,
        skills
    )

    next()
}
